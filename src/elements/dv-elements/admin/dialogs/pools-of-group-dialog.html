<link rel="import"
      href="../../../../bower_components/polymer/polymer-element.html">
<link rel="import"
      href="../../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import"
      href="../../../../bower_components/iron-pages/iron-pages.html">
<link rel="import"
      href="../../../../bower_components/iron-selector/iron-selector.html">
<link rel="import"
      href="../../../../bower_components/paper-button/paper-button.html">
<link rel="import"
      href="../../../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import"
      href="../../../../bower_components/paper-input/paper-input.html">
<link rel="import"
      href="../../../../bower_components/paper-item/paper-item.html">
<link rel="import"
      href="../../../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import"
      href="../../../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import"
      href="../../../../bower_components/paper-tabs/paper-tab.html">
<link rel="import"
      href="../../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import"
      href="../../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import"
      href="../../../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import"
      href="../../../../bower_components/vaadin-grid/vaadin-grid-filter.html">
<link rel="import"
      href="../../../../bower_components/vaadin-grid/vaadin-grid-column-group.html">
<link rel="import"
      href="../../../../bower_components/vaadin-grid/vaadin-grid-table-scroll-behavior.html">
<link rel="import"
      href="../../../../bower_components/vaadin-grid/vaadin-grid-cell-click-behavior.html">
<link rel="import"
      href="../../../../elements/dv-elements/admin/dialogs/pool-info-dialog.html">
<link rel="import"
      href="../../../../elements/dv-elements/admin/dv-admin-mixins.html">

<dom-module id="pools-of-group-dialog">
    <template>
        <style>
            :host {
                display: none;
                @apply(--layout-vertical);
                height: 100%;
                width: 90%;
                -webkit-font-smoothing: antialiased;
            }

            paper-toolbar {
                color: var(--dv-charcoal-grey);
                background: var(--dv-light-grey);
            }

            paper-button {
                background: var(--dv-charcoal-grey);
                color: var(--dv-main-background);
            }

            paper-button#send {
                margin-left: 5px;
                margin-bottom: 20px;
            }

            paper-checkbox {
                --paper-checkbox-checked-color: var(--dv-charcoal-grey);
                --paper-checkbox-checked-ink-color: var(--dv-charcoal-grey);
                --paper-checkbox-unchecked-color: var(--dv-light-grey);
                --paper-checkbox-unchecked-ink-color: var(--dv-light-grey);
                --paper-checkbox-label-color: var(--dv-charcoal-grey);
            }

            paper-tabs {
                background-color: #afafaf;
                color: #ffffff;
                height: 30px;
                padding: 5px 0px;
            }

            paper-dropdown-menu {
                padding: 0px 55px;
            }

            vaadin-grid {
                position: relative;
                height: 100%;
                --divider-color: #d4d4d4;

                --vaadin-grid-cell: {
                    padding: 0 8px;
                    height: 32px;
                    border-right: 1px solid #d4d4d4;
                    box-sizing: border-box;
                    font-size: 8pt;
                    cursor: default;
                };

                --vaadin-grid-header-cell: {
                    height: 36px;
                    border-bottom: 1px solid #d4d4d4;
                    background-image: linear-gradient(to bottom, #fafafa 2%, #efefef 98%);
                    font-size: 9pt;
                    text-style: bold;
                    text-align: center;
                    cursor: default;
                };

                --vaadin-grid-footer-cell: {
                    height: 36px;
                    border-bottom: 1px solid #d4d4d4;
                    background-image: linear-gradient(to bottom, #fafafa 2%, #efefef 98%);
                    font-size: 8pt;
                    text-style: bold;
                    cursor: default;
                };

                --vaadin-grid-body-row-odd-cell: {
                    background-color: #f5f5f5;
                };
            }

            .opaque {
                height: 100%;
                opacity: 1.0;
                background: var(--dv-main-background);
                color: var(--dv-main-foreground);
                border: groove;
                border-color: var(--dv-blue-500);
                border-width: thick;
            }

            input {
                @apply(--layout-flex);
                height: 95%;
                width: 95%;
                padding-right: 5px;
            }

            table {
                margin: 0 100px;
                font-size: 8pt;
            }

            .actionable {
                cursor: pointer;
                color: var(--dv-indigo-500);
            }

            .markedtrue {
                color: var(--dv-red-500);
            }

            .status0 { /* enabled */
                background: var(--dv-green-900);
                color: var(--dv-main-background);
            }

            .status1 { /* rdonly */
                background: #fff844;
                color: var(--dv-charcoal-grey);
            }

            .status2 { /* disabled strict */
                background: var(--dv-red-900);
                color: var(--dv-main-background);
            }

            .status3 {
                background: var(--dv-charcoal-grey);
                color: var(--dv-main-background);
            }

            .status4 { /* pending */
                background: var(--dv-orange-900);
                color: var(--dv-charcoal-grey);
            }

            .disk {
                position: relative;
                padding-right: 30px;
                width: 100%;
                height: 30px;
            }

            iron-pages {
                height: 80%;
                width: 100%;
            }

            .tablediv {
                height: 100%;
            }
        </style>

        <iron-ajax
                id="AjaxPools"
                method="GET"
                handle-as="json"
                on-response="_handlePoolsResponse"
                on-error="_handlePoolsError">
        </iron-ajax>
        <iron-ajax
                id="AjaxInfo"
                method="GET"
                handle-as="json"
                on-response="_handlePoolInfoResponse"
                on-error="_handlePoolInfoError">
        </iron-ajax>
        <iron-ajax
                id="AjaxPatch"
                method="PATCH"
                handle-as="json"
                on-error="_handlePatchError">
        </iron-ajax>
        <div class="opaque">
            <paper-toolbar>
                <div slot="top" class="spacer title"><strong>Pool Group:
                    [[group]]</strong>
                </div>
                <paper-button slot="top" dialog-dismiss>Close</paper-button>
            </paper-toolbar>
            <paper-tabs selected="{{selected}}" noink="">
                <paper-tab>Cell Info</paper-tab>
                <paper-tab>Space Info</paper-tab>
                <paper-tab>Request Info</paper-tab>
            </paper-tabs>
            <iron-pages selected="{{selected}}">
                <div class="tablediv">
                    <paper-button id="send" on-tap="_handlePoolModeChange">
                        Send
                    </paper-button>
                    <paper-dropdown-menu label="Change Pool Mode" noink
                                         no-animations>
                        <iron-selector slot="dropdown-content"
                                       class="dropdown-content"
                                       selected="{{mode}}">
                            <paper-item>Enabled</paper-item>
                            <paper-item>Disabled Read-Only</paper-item>
                            <paper-item>Disabled Strict</paper-item>
                        </iron-selector>
                    </paper-dropdown-menu>
                    <vaadin-grid aria-label="Cell Info" id="cellinfo"
                                 items="[[pools]]" multi-sort="true"
                                 size="50">
                        <vaadin-grid-selection-column auto-select>
                        </vaadin-grid-selection-column>
                        <vaadin-grid-column-group resizable>
                            <template class="header">
                                <vaadin-grid-sorter path="mode">
                                    Status
                                </vaadin-grid-sorter>
                            </template>
                            <vaadin-grid-column width="150px">
                                <template class="header">
                                    <vaadin-grid-filter
                                            aria-label="Pool Status"
                                            path="mode"
                                            value="[[_filterMode]]">
                                        <input slot="filter"
                                               placeholder="Pool Mode"
                                               value="{{_filterMode::input}}"
                                               focus-target="">
                                    </vaadin-grid-filter>
                                </template>
                                <template><span
                                        class$="status[[item.status]]"><strong>{{item.mode}}</strong></span>
                                </template>
                            </vaadin-grid-column>
                        </vaadin-grid-column-group>
                        <vaadin-grid-column-group resizable>
                            <template class="header">
                                <vaadin-grid-sorter path="cell">
                                    Cell
                                </vaadin-grid-sorter>
                            </template>
                            <vaadin-grid-column width="175px">
                                <template class="header">
                                    <vaadin-grid-filter aria-label="Cell"
                                                        path="cell"
                                                        value="[[_filterCell]]">
                                        <input slot="filter"
                                               placeholder="Cell"
                                               value="{{_filterCell::input}}"
                                               focus-target="">
                                    </vaadin-grid-filter>
                                </template>
                                <template><span class="actionable"
                                                on-tap="_openPoolInfoDialog">[[item.cell]]</span>
                                </template>
                            </vaadin-grid-column>
                        </vaadin-grid-column-group>
                        <vaadin-grid-column-group resizable>
                            <template class="header">
                                <vaadin-grid-sorter path="domain">
                                    Domain
                                </vaadin-grid-sorter>
                            </template>
                            <vaadin-grid-column width="200px">
                                <template class="header">
                                    <vaadin-grid-filter aria-label="Domain"
                                                        path="domain"
                                                        value="[[_filterDomain]]">
                                        <input slot="filter"
                                               placeholder="Domain"
                                               value="{{_filterDomain::input}}"
                                               focus-target="">
                                    </vaadin-grid-filter>
                                </template>
                                <template>[[item.domain]]</template>
                            </vaadin-grid-column>
                        </vaadin-grid-column-group>
                        <vaadin-grid-column-group>
                            <template class="header">
                                <vaadin-grid-sorter path="eventQueue">
                                    Event Queue
                                </vaadin-grid-sorter>
                            </template>
                            <vaadin-grid-column width="75px">
                                <template class="header">
                                </template>
                                <template>[[item.eventQueue]]</template>
                            </vaadin-grid-column>
                        </vaadin-grid-column-group>
                        <vaadin-grid-column-group>
                            <template class="header">
                                <vaadin-grid-sorter path="threads">
                                    Thread Count
                                </vaadin-grid-sorter>
                            </template>
                            <vaadin-grid-column width="75px">
                                <template class="header">
                                </template>
                                <template>[[item.threads]]</template>
                            </vaadin-grid-column>
                        </vaadin-grid-column-group>
                        <vaadin-grid-column-group>
                            <template class="header">
                                <vaadin-grid-sorter path="ping">
                                    Ping (ms)
                                </vaadin-grid-sorter>
                            </template>
                            <vaadin-grid-column width="75px">
                                <template class="header">
                                </template>
                                <template>[[item.ping]]</template>
                            </vaadin-grid-column>
                        </vaadin-grid-column-group>
                        <vaadin-grid-column-group>
                            <template class="header">
                                <vaadin-grid-sorter path="created.value">
                                    Created
                                </vaadin-grid-sorter>
                            </template>
                            <vaadin-grid-column width="150px">
                                <template class="header">
                                </template>
                                <template>[[item.created.formatted]]
                                </template>
                            </vaadin-grid-column>
                        </vaadin-grid-column-group>
                        <vaadin-grid-column-group>
                            <template class="header">
                                <vaadin-grid-sorter path="version">
                                    Version
                                </vaadin-grid-sorter>
                            </template>
                            <vaadin-grid-column width="150px">
                                <template class="header">
                                    <vaadin-grid-filter aria-label="Version"
                                                        path="version"
                                                        value="[[_filterVersion]]">
                                        <input slot="filter"
                                               placeholder="Version"
                                               value="{{_filterVersion::input}}"
                                               focus-target="">
                                    </vaadin-grid-filter>
                                </template>
                                <template>[[item.version]]</template>
                            </vaadin-grid-column>
                        </vaadin-grid-column-group>
                    </vaadin-grid>
                </div>
                <div class="tablediv">
                    <vaadin-grid aria-label="Space Info" id="spaceinfo"
                                 items="[[pools]]" multi-sort="true"
                                 size="50">
                        <vaadin-grid-column-group resizable>
                            <template class="header">
                                <vaadin-grid-sorter path="cell">
                                    Cell
                                </vaadin-grid-sorter>
                            </template>
                            <vaadin-grid-column width="175px">
                                <template class="header">
                                    <vaadin-grid-filter aria-label="Cell"
                                                        path="cell"
                                                        value="[[_filterCell]]">
                                        <input slot="filter"
                                               placeholder="Cell"
                                               value="{{_filterCell::input}}"
                                               focus-target="">
                                    </vaadin-grid-filter>
                                </template>
                                <template><span class="actionable"
                                                on-tap="_openPoolInfoDialog">[[item.cell]]</span>
                                </template>
                            </vaadin-grid-column>
                        </vaadin-grid-column-group>
                        <vaadin-grid-column-group resizable>
                            <template class="header">
                                <vaadin-grid-sorter path="domain">
                                    Domain
                                </vaadin-grid-sorter>
                            </template>
                            <vaadin-grid-column width="200px">
                                <template class="header">
                                    <vaadin-grid-filter aria-label="Domain"
                                                        path="domain"
                                                        value="[[_filterDomain]]">
                                        <input slot="filter"
                                               placeholder="Domain"
                                               value="{{_filterDomain::input}}"
                                               focus-target="">
                                    </vaadin-grid-filter>
                                </template>
                                <template>[[item.domain]]</template>
                            </vaadin-grid-column>
                        </vaadin-grid-column-group>
                        <vaadin-grid-column-group>
                            <template class="header">
                                <vaadin-grid-sorter path="total">
                                    Total Space (MiB)
                                </vaadin-grid-sorter>
                            </template>
                            <vaadin-grid-column width="150px">
                                <template class="header">
                                </template>
                                <template>[[item.total]]</template>
                            </vaadin-grid-column>
                        </vaadin-grid-column-group>
                        <vaadin-grid-column-group>
                            <template class="header">
                                <vaadin-grid-sorter path="free">
                                    Free Space (MiB)
                                </vaadin-grid-sorter>
                            </template>
                            <vaadin-grid-column width="150px">
                                <template class="header">
                                </template>
                                <template>[[item.free]]</template>
                            </vaadin-grid-column>
                        </vaadin-grid-column-group>
                        <vaadin-grid-column-group>
                            <template class="header">
                                <vaadin-grid-sorter path="precious">
                                    Precious Space (MiB)
                                </vaadin-grid-sorter>
                            </template>
                            <vaadin-grid-column width="150px">
                                <template class="header">
                                </template>
                                <template>[[item.precious]]</template>
                            </vaadin-grid-column>
                        </vaadin-grid-column-group>
                        <vaadin-grid-column-group>
                            <template class="header">
                            </template>
                            <vaadin-grid-column width="150px">
                                <template class="header">
                                </template>
                                <template>
                                    <layout-bar class="disk"
                                                diskspace$="[[item.disk]]"></layout-bar>
                                </template>
                            </vaadin-grid-column>
                        </vaadin-grid-column-group>
                    </vaadin-grid>
                </div>
                <div class="tablediv">
                    <vaadin-grid aria-label="Request Info" id="requestinfo"
                                 items="[[pools]]" multi-sort="true"
                                 size="100">
                        <vaadin-grid-column-group resizable>
                            <template class="header">
                                <vaadin-grid-sorter path="cell">
                                    Cell
                                </vaadin-grid-sorter>
                            </template>
                            <vaadin-grid-column width="175px">
                                <template class="header">
                                    <vaadin-grid-filter aria-label="Cell"
                                                        path="cell"
                                                        value="[[_filterCell]]">
                                        <input slot="filter"
                                               placeholder="Cell"
                                               value="{{_filterCell::input}}"
                                               focus-target="">
                                    </vaadin-grid-filter>
                                </template>
                                <template><span class="actionable"
                                                on-tap="_openPoolInfoDialog">[[item.cell]]</span>
                                </template>
                                <template class="footer">TOTAL</template>
                            </vaadin-grid-column>
                        </vaadin-grid-column-group>
                        <vaadin-grid-column-group resizable>
                            <template class="header">
                                <vaadin-grid-sorter path="domain">
                                    Domain
                                </vaadin-grid-sorter>
                            </template>
                            <vaadin-grid-column width="200px">
                                <template class="header">
                                    <vaadin-grid-filter aria-label="Domain"
                                                        path="domain"
                                                        value="[[_filterDomain]]">
                                        <input slot="filter"
                                               placeholder="Domain"
                                               value="{{_filterDomain::input}}"
                                               focus-target="">
                                    </vaadin-grid-filter>
                                </template>
                                <template>[[item.domain]]</template>
                            </vaadin-grid-column>
                        </vaadin-grid-column-group>
                        <template is="dom-repeat" items="[[queues]]"
                                  as="queue">
                            <vaadin-grid-column-group>
                                <template class="header">[[queue]]
                                </template>
                                <vaadin-grid-column>
                                    <template class="header">
                                        <vaadin-grid-sorter
                                                path="queue.active">
                                            Active
                                        </vaadin-grid-sorter>
                                    </template>
                                    <template>
                                        [[_queueAttribute(queue, item, 'active')]]
                                    </template>
                                    <template class="footer">
                                        [[_queueTotal(queue, 'active')]]
                                    </template>
                                </vaadin-grid-column>
                                <vaadin-grid-column>
                                    <template class="header">
                                        <vaadin-grid-sorter
                                                path="queue.maxActive">
                                            Max
                                        </vaadin-grid-sorter>
                                    </template>
                                    <template>
                                        [[_queueAttribute(queue, item, 'maxActive')]]
                                    </template>
                                    <template class="footer">
                                        [[_queueTotal(queue, 'maxActive')]]
                                    </template>
                                </vaadin-grid-column>
                                <vaadin-grid-column>
                                    <template class="header">
                                        <vaadin-grid-sorter
                                                path="queue.queued">
                                            Queued
                                        </vaadin-grid-sorter>
                                        <template>0</template>
                                    </template>
                                    <template>
                                        <span class$="marked[[_isNonZero(queue, item, 'queued')]]">
                                            [[_queueAttribute(queue, item, 'queued')]]
                                        </span>
                                    </template>
                                    <template class="footer">
                                        [[_queueTotal(queue, 'queued')]]
                                    </template>
                                </vaadin-grid-column>
                            </vaadin-grid-column-group>
                        </template>
                    </vaadin-grid>
                </div>
            </iron-pages>
        </div>
    </template>

    <script>
        class PoolsOfGroupDialog extends Polymer.mixinBehaviors([Polymer.PaperDialogBehavior],
            DcacheViewMixins.AdminAutoRefresh(DcacheViewMixins.AdminBase(Polymer.Element))) {

            static get is() {
                return 'pools-of-group-dialog';
            }

            static get properties() {
                return {
                    group: {
                        type: String,
                        notify: true
                    },

                    pools: {
                        type: Array,
                        notify: true
                    },

                    numberOfPools: {
                        type: Number
                    },

                    incoming: {
                        type: Array,
                        value: []
                    },

                    queues: {
                        type: Array,
                        notify: true
                    },

                    queuetotals: {
                        type: Object,
                        notify: true
                    },

                    mode: {
                        type: Number,
                        value: 0,
                    },

                    selected: {
                        type: Number,
                        value: 0,
                        notify: true
                    }
                }
            }

            constructor(group) {
                super();
                this.group = group;
                this.incoming = [];
                this.modal = true;
            }

            connectedCallback() {
                super.connectedCallback();
                this.refreshAndReset(this._sendPoolsRequest.bind(this), 60000);
            }

            close() {
                this.popDialog();
                this.stopRefresh();
                super.close();
            }

            _handlePoolInfoError(event) {
                this.handleError(`Could not process pool info request: ${event.detail.error.message}`);
            }

            _handlePoolModeChange() {
                let rdonly = false;
                let strict = false;
                let pending = "";
                const selected = {};

                switch (this.mode) {
                    case 1:
                        rdonly = true;
                        pending = "read-only (pending)";
                        break;
                    case 2:
                        strict = true;
                        pending = "disabled (pending)";
                        break;
                    case 0:
                    default:
                        pending = "enabled (pending)";
                        break;
                }

                this.$.cellinfo.selectedItems.forEach((item) => {
                    this._sendPoolModeChange(item.cell, rdonly, strict);
                    selected[item.cell] = pending;
                });

                const current = this.pools;

                current.forEach((pool) => {
                    if (selected.hasOwnProperty(pool.cell)) {
                        pool.mode = selected[pool.cell];
                        pool.status = 4;
                    }
                });

                this.pools = [];
                this.pools = current;

                this.resetRefresh(this._sendPoolsRequest.bind(this), 60000);
            }

            _handlePoolsError(event) {
                this.handleError(`Could not process pools of group request: ${event.detail.error.message}`);
            }

            _handlePoolInfoResponse(event) {
                const result = event.detail.response;
                if (!result.poolData) {
                    const pool = this.getNameFromUrl(event.detail.url);
                    result.poolData = {'deadPool': pool};
                }
                this.incoming.push(result.poolData);
                if (this.incoming.length === this.numberOfPools) {
                    this._processPoolInfo();
                }
            }

            _handlePoolsResponse(event) {
                const pools = event.detail.response;
                if (pools && pools.length > 0) {
                    this.numberOfPools = pools.length;
                    this.incoming = [];
                    pools.forEach((pool) => {
                        this._sendPoolInfoRequest(pool);
                    });
                } else {
                    this.numberOfPools = 0;
                    this.handleError('Request returned no pools for group; ' +
                        'please refresh and try again.');
                }
            }

            _handlePatchError(event) {
                this.handleError(`Could not change pool mode: ${event.detail.error.message}`);
            }

            _isNonZero(queue, item, attribute) {
                if (!item) {
                    return false;
                }
                return this._queueAttribute(queue, item, attribute) > 0;
            }

            _openPoolInfoDialog(e) {
                e.stopPropagation();
                this.openPoolInfoDialog(e.target.innerText, null);
            }

            _processPoolInfo() {
                const pools = [];
                const queues = ['movers', 'stores', 'restores', 'p2p', 'p2pClient'];

                this.incoming.forEach((poolData) => {
                    let pool;

                    if (poolData.deadPool) {
                        pool = {
                            'cell': poolData.deadPool,
                            'domain': '',
                            'eventQueue': 0,
                            'threads': 0,
                            'ping': 0,
                            'created': '',
                            'version': '',
                            'mode': 'OFFLINE',
                            'status': 3,
                            'total': 0,
                            'free': 0,
                            'precious': 0,
                            'movers': {},
                            'stores': {},
                            'restores': {},
                            'p2p': {},
                            'p2pClient': {},
                            'disk': {}
                        };
                    } else {
                        const store = poolData.detailsData.costData.store;
                        const restore = poolData.detailsData.costData.restore;

                        delete store.maxActive;
                        delete restore.maxActive;

                        const space = poolData.detailsData.costData.space;

                        const total = this.convertToMiB(space.total);
                        const free = this.convertToMiB(space.free);
                        const precious = this.convertToMiB(space.precious);
                        const removable = this.convertToMiB(space.removable);

                        pool = {
                            'cell': poolData.cellData.cellName,
                            'domain': poolData.cellData.domainName,
                            'eventQueue': poolData.cellData.eventQueueSize,
                            'threads': poolData.cellData.threadCount,
                            'ping': poolData.cellData.roundTripTime,
                            'created': this.convertDatestampToObject(poolData.cellData.creationTime),
                            'version': poolData.cellData.version,
                            'mode': poolData.detailsData.poolMode,
                            'status': this._status(poolData.detailsData.poolMode),
                            'total': total,
                            'free': free,
                            'precious': precious,
                            'movers': poolData.detailsData.costData.mover,
                            'stores': store,
                            'restores': restore,
                            'p2p': poolData.detailsData.costData.p2p,
                            'p2pClient': poolData.detailsData.costData.p2pClient,
                            'disk': {
                                'total': total, 'precious': precious,
                                'free': free, 'removable': removable
                            }
                        };

                        const extended = poolData.detailsData.costData.extendedMoverHash;

                        Object.keys(extended).forEach((key) => {
                            if (key !== 'regular') {
                                if (queues.indexOf(key) === -1) {
                                    queues.push(key);
                                }
                                pool[key] = extended[key];
                            }
                        });
                    }

                    pools.push(pool);
                });

                this.queuetotals = this._queueTotals(pools, queues);
                this.pools = pools;
                this.queues = queues;
                this.incoming = [];
            }

            _queueAttribute(queue, item, attribute) {
                if (!item) {
                    return null;
                }
                const namedQueue = item[queue];
                if (namedQueue) {
                    return namedQueue[attribute];
                }
                return null;
            }

            _queueTotal(queue, attribute) {
                return this.queuetotals[queue][attribute];
            }

            _queueTotals(pools, queues) {
                const qtotals = {};

                queues.forEach((queue) => {
                    qtotals[queue] = {};

                    pools.forEach((pool) => {
                        if (pool[queue]) {
                            if (pool[queue].active || pool[queue].active === 0) {
                                if (qtotals[queue].active || qtotals[queue].active === 0) {
                                    qtotals[queue].active += pool[queue].active;
                                } else {
                                    qtotals[queue].active = pool[queue].active;
                                }
                            }
                            if (pool[queue].maxActive || pool[queue].maxActive === 0) {
                                if (qtotals[queue].maxActive || qtotals[queue].maxActive === 0) {
                                    qtotals[queue].maxActive += pool[queue].maxActive;
                                } else {
                                    qtotals[queue].maxActive = pool[queue].maxActive;
                                }
                            }
                            if (pool[queue].queued || pool[queue].queued === 0) {
                                if (qtotals[queue].queued || qtotals[queue].queued === 0) {
                                    qtotals[queue].queued += pool[queue].queued;
                                } else {
                                    qtotals[queue].queued = pool[queue].queued;
                                }
                            }
                        }
                    });
                });

                return qtotals;
            }

            _sendPoolInfoRequest(pool) {
                this.$.AjaxInfo.url = this.getUrl(`pools/${pool}/usage`, null);
                this.$.AjaxInfo.headers = this.getHeaders();
                this.$.AjaxInfo.generateRequest();
            }

            _sendPoolModeChange(pool, rdonly, strict) {
                this.$.AjaxPatch.url
                    = this.getUrl(`pools/${pool}/usage/mode`, null);
                this.$.AjaxPatch.headers = this.getHeaders();
                this.$.AjaxPatch.body = {
                    "rdonly": rdonly, "strict": strict,
                    "resilience": true
                };
                this.$.AjaxPatch.generateRequest();
            }

            _sendPoolsRequest() {
                const path = `poolgroups/${this.group}/pools`;
                this.$.AjaxPools.url = this.getUrl(path, null);
                this.$.AjaxPools.headers = this.getHeaders();
                this.$.AjaxPools.generateRequest();
            }

            _status(mode) {
                switch (mode) {
                    case 'enabled':
                        return 0;
                    case 'disabled(store,stage,p2p-client)':
                        return 1;
                    case 'disabled(fetch,store,stage,p2p-client,p2p-server)':
                        return 2;
                    default:
                        return 3;
                }
            }
        }

        window.customElements.define(PoolsOfGroupDialog.is, PoolsOfGroupDialog);
    </script>
</dom-module>