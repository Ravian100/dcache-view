<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="gravatar-request.html">
<link rel="import" href="identicon-request.html">

<dom-module id="user-image">
    <template>
        <style>
            :host {
                --user-image-border-radius: 0;
                --user-image-width: 60px;
                --user-image-height: 60px;
            }
            .container{
                width: 100%;
                height: 100%;
                display: flex;
                justify-content: center;

            }
            paper-spinner {
                margin:auto;
                width: 20px;
                height: 20px;
            }
            .hide {
                display: none !important;
            }
            img {
                border-radius: var(--user-image-border-radius);
                width: var(--user-image-width);
                height: var(--user-image-height);
            }
        </style>
        <div class="container">
            <gravatar-request id="gravatar"
                              size="[[size]]"
                              on-gravatar-request-error="_gravatarResponseListener"
                              on-gravatar-request-successful="_gravatarResponseListener"></gravatar-request>
            <img id="avatar">
            <paper-spinner id="spinner" active="[[loading]]"></paper-spinner>
        </div>
    </template>
    <script>
        class UserImage extends Polymer.Element
        {
            static get is()
            {
                return 'user-image';
            }
            static get properties()
            {
                return {
                    email: {
                        type: String,
                        notify: true,
                    },
                    fallbackValue: {
                        type: String,
                        value: 'Anonymous',
                        notify: true,
                    },
                    size: {
                        type: Number,
                        value: 60,
                        notify: true
                    },
                    loading: {
                        type: Boolean,
                        value: function () {
                            return window.CONFIG.avatarSrc === undefined || window.CONFIG.avatarSrc === "";
                        },
                        notify: true
                    },
                    src: {
                        type: String,
                        notify: true,
                    },
                    link: {
                        type: String,
                        notify: true,
                    },
                    gravatarSwitch: {
                        type: Boolean,
                        notify: true
                    },
                }
            }
            static get observers()
            {
                return [
                    '_srcChanged(src)',
                    '_visibility(loading)'
                ];
            }
            constructor()
            {
                super();
                this._requestNewImageListener = this._requestNewImage.bind(this)
            }
            ready()
            {
                super.ready();
                Polymer.RenderStatus.afterNextRender(this, ()=> {
                    if (window.CONFIG.avatarSrc === undefined || window.CONFIG.avatarSrc === "") {
                        if (sessionStorage.getItem('useGravatar') === "yes") {
                            if (this.email===undefined || this.email === null
                                || this.email === "" || this.email === "not available") {
                                this.src = this._fallbackCall(this.fallbackValue);
                                return;
                            }
                            this._gravatarRequestWithFallBack();
                        } else {
                            this.src = this._fallbackCall(this.fallbackValue);
                        }
                    } else {
                        this.src = window.CONFIG.avatarSrc;
                    }
                });
            }
            connectedCallback()
            {
                super.connectedCallback();
                window.addEventListener('dv-user-image-request', this._requestNewImageListener);
            }
            disconnectedCallback()
            {
                super.disconnectedCallback();
                window.removeEventListener('dv-user-image-request', this._requestNewImageListener);
            }
            _gravatarResponseListener(e)
            {
                if (e.detail.link) {
                    this.src = e.detail.link;
                    sessionStorage.setItem('useGravatar', 'yes');
                    this.gravatarSwitch = true;
                } else {
                    this.src = this._fallbackCall(this.fallbackValue);
                    this.dispatchEvent(new CustomEvent('dv-namespace-show-message-toast', {
                        detail: {message: e.message}, bubbles: true, composed: true
                    }));
                }
            }
            _srcChanged(n)
            {
                if (!(n === undefined || n === "")) {
                    this.loading = false;
                    this.$.avatar.src = n;
                    this.updateStyles();
                }
            }
            _fallbackCall(value)
            {
                const uIcon = new IdenticonRequest(value);
                uIcon.size = this.size;
                window.CONFIG.avatarSrc = uIcon.generateSrc();
                sessionStorage.setItem('useGravatar', 'no');
                this.gravatarSwitch = false;
                return uIcon.generateSrc();
            }
            _visibility(loading) {
                if (loading) {
                    this.$.avatar.classList.add('hide');
                    this.$.spinner.classList.remove('hide');
                } else {
                    this.$.avatar.classList.remove('hide');
                    this.$.spinner.classList.add('hide');
                }
            }
            _gravatarRequestWithFallBack()
            {
                try {
                    const gravatar = this.$.gravatar;
                    gravatar._counter = 0;
                    gravatar.request(this.email);
                } catch (e) {
                    this.src = this._fallbackCall(this.fallbackValue);
                    this.dispatchEvent(new CustomEvent('dv-namespace-show-message-toast', {
                        detail: {message: `${e.message}`}, bubbles: true, composed: true
                    }));
                }

                /**
                 * If no response is received from the request after 1.5 seconds,
                 * use the fallback option.
                 */
                setTimeout(()=>{
                    if (!window.CONFIG.avatarSrc) {
                        this.src = this._fallbackCall(this.fallbackValue);
                    }
                }, 1500);
            }
            _requestNewImage(e)
            {
                if (e.detail.type === "gravatar") {
                    this._gravatarRequestWithFallBack();
                } else if (e.detail.type === "identicon") {
                    this.src = this._fallbackCall(this.fallbackValue);
                }
            }
        }
        window.customElements.define(UserImage.is, UserImage);
    </script>
</dom-module>