<link rel="import" href="../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../bower_components/iron-jsonp-library/iron-jsonp-library.html">

<dom-module id="gravatar-request">
    <template>
        <iron-jsonp-library
                id="jsonp"
                library-url="[[libraryUrl]]"
                library-loaded="{{loaded}}"
                library-error-message="{{errorMessage}}"></iron-jsonp-library>
    </template>
    <script>
        class GravatarRequest extends Polymer.Element
        {
            constructor()
            {
                super();
            }

            static get is()
            {
                return 'gravatar-request';
            }
            static get properties()
            {
                return {
                    email: {
                        type: String,
                        notify: true,
                        observer: 'request'
                    },
                    size: {
                        type: Number,
                        value: 60,
                        notify: true
                    },
                    hash: {
                        type: Array,
                        notify: true,
                        observer: '_generateLibraryUrl'
                    },
                    errorMessage: {
                        type: String,
                        observer: '_errorOccurred'
                    },
                    loaded: {
                        type: Boolean,
                        observer: '_generateGravatarSrc'
                    },
                    _counter: {
                        type: Number,
                        value: 0,
                    }
                }
            }
            ready()
            {
                super.ready();
                this._ensureAttribute('hidden', true);
            }
            request(listOfEmail)
            {
                if (listOfEmail === undefined || listOfEmail === null || listOfEmail === "") {
                    throw new Error("Unable to request for Gravatar, no email provided.");
                }
                const emailArray = listOfEmail.split(",");

                const len = emailArray.length;
                const hash = [];
                for (let i=0; i<len; i++) {
                    hash[i] = md5((emailArray[i].trim()).toLowerCase());
                }
                this.hash = hash;
            }
            _generateLibraryUrl(hash)
            {
                if (hash.length > 0 && this._counter < hash.length) {
                    this.$.jsonp.libraryUrl =
                        `https://en.gravatar.com/${hash[this._counter]}.json?callback=%%callback%%`;
                    this._counter++;
                } else {
                    throw new Error("No associated Gravatar available with these emails.");
                }
            }
            _errorOccurred(err)
            {
                if (err !== null) {
                    try {
                        this._generateLibraryUrl(this.hash);
                    } catch (e) {
                        this.dispatchEvent(new CustomEvent('gravatar-request-error', {detail: {message: err}}));
                    }
                }
            }
            _generateGravatarSrc(isSuccessful)
            {
                if (isSuccessful) {
                    window.CONFIG.avatarSrc =
                        `https://secure.gravatar.com/avatar/${this.hash[+this._counter-1]}?s=${this.size}`;
                    this.dispatchEvent(new CustomEvent('gravatar-request-successful', {detail: {
                        link: `https://secure.gravatar.com/avatar/${this.hash[+this._counter-1]}?s=${this.size}`}}));
                }
            }
        }
        window.customElements.define(GravatarRequest.is, GravatarRequest);
    </script>
</dom-module>
