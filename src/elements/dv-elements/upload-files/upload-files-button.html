<link rel="import" href="../../../bower_components/polymer/polymer-element.html">
<script src="../utils/dcache-view-uploader/dcache-view-uploader.js"></script>

<link rel="import" href="upload-toast-file.html">
<dom-module id="upload-files-button">
    <template>
        <style>
            :host{
                display: inline-block;
            }
            #files {
                width: 0.1px;
                height: 0.1px;
                opacity: 0;
                overflow: hidden;
                position: absolute;
                z-index: -1;
            }
        </style>
        <div>
            <input id="files" type="file" multiple>
            <label for="files">
                <paper-icon-button icon="icons:cloud-upload"></paper-icon-button>
                <paper-tooltip>upload files</paper-tooltip>
            </label>
        </div>
    </template>
    <script>
        class UploadFilesButton extends Polymer.Element
        {
            static get is()
            {
                return 'upload-files-button';
            }

            connectedCallback()
            {
                super.connectedCallback();
                this.$.files.addEventListener('change', this.handleFileSelection.bind(this));
                window.addEventListener('dv-namespace-upload-files', ()=>{
                    this.$.files.click();
                });
            }
            disconnectedCallback()
            {
                super.disconnectedCallback();
                this.$.files.removeEventListener('change', this.handleFileSelection);
                window.removeEventListener('dv-namespace-upload-files', ()=>{
                    this.$.files.click();
                });
            }

            handleFileSelection(e)
            {
                e.stopPropagation();
                e.preventDefault();
                app.$.uploadToast.close();
                if (window.File && window.FileReader && window.FileList && window.Blob) {
                    app.$.uploadToast.open();
                    this.uploadFile(e.target.files);
                } else {
                    app.$.toast.text = 'No support for the File API in this web browser. ';
                    app.$.toast.show();
                }
            }

            uploadFile(files)
            {
                var uploadList = app.$.uploadToast.querySelector("#uploadList");
                uploadList.innerHTML ="";
                var path = ((app.$.homedir.querySelector('view-file').path).endsWith("/"))
                    ? app.$.homedir.querySelector('view-file').path
                    : app.$.homedir.querySelector('view-file').path + "/";
                var f;
                for (var i=0; f = files[i]; i++) {
                    var el = new UploadToastFile(f.name, "REGULAR", f.type);
                    el.setAttribute("id", i.toString());
                    uploadList.appendChild(el);
                    const upLs = el;
                    const uploadURL = window.CONFIG["dcache-view.endpoints.webdav"] === "" ?
                        `${window.location.protocol}//${window.location.hostname}:2880${path}${f.name}` :
                        path.startsWith('/') ?
                        `${window.CONFIG["dcache-view.endpoints.webdav"]}${path.slice(1)}${f.name}` :
                        `${window.CONFIG["dcache-view.endpoints.webdav"]}${path}${f.name}`;
                    var uploader = new UploadHandler({
                        file: f,
                        upauth: app.getAuthValue(),
                        url: uploadURL,
                        onComplete: function (data) {
                            var progressBar = upLs.shadowRoot.querySelector('paper-progress');
                            progressBar.indeterminate = false;
                            progressBar.value = 100;
                            progressBar.classList.remove("error", "progress");
                            progressBar.classList.add("complete");

                            upLs.inProgress = false;
                            upLs.hasError = false;
                            upLs.isComplete = true;
                            upLs.message = "Uploaded";
                            var vf = document.querySelector('view-file');
                            var ed = vf.shadowRoot.querySelector('empty-directory');
                            if (ed != null) {
                                vf.shadowRoot.querySelector('#content').removeChild(ed);
                            }
                            var list = vf.shadowRoot.querySelector('iron-list');
                            list.unshift('items',
                                    {
                                        "fileName" : data.name,
                                        "fileMimeType" : data.type,
                                        "fileLocality" : "",
                                        "size" : data.size,
                                        "fileType" : "REGULAR",
                                        "mtime" : data.lastModified,
                                        "creationTime" : Date.now()
                                    }
                            );
                        }.bind(this),

                        onProgress: function (evt) {
                            if (evt.lengthComputable) {
                                var progressBar = upLs.shadowRoot.querySelector('paper-progress');
                                progressBar.classList.remove("error", "complete");
                                progressBar.classList.add("progress");
                                progressBar.indeterminate = false;
                                progressBar.value = (evt.load / evt.total) * 100;
                            }
                            upLs.progressValue = progressBar.value;
                            upLs.inProgress = true;
                            upLs.isComplete = false;
                            upLs.hasError = false;
                        }.bind(this),

                        onError: function (evt) {
                            var progressBar = upLs.shadowRoot.querySelector('paper-progress');
                            progressBar.classList.remove("progress", "complete");
                            progressBar.classList.add("error");
                            progressBar.indeterminate = false;
                            progressBar.value = 100;
                            upLs.message = evt.statusText;
                            upLs.inProgress = false;
                            upLs.isComplete = false;
                            upLs.hasError = true;
                        }.bind(this)
                    });
                    uploader.upload();
                    Polymer.dom.flush();
                }
                Polymer.dom.flush();
            }
        }
        window.customElements.define(UploadFilesButton.is, UploadFilesButton);
    </script>
</dom-module>