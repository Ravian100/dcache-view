<!--
FIXME:Consider making it be a behaviour that will be share across all necessary elements
-->
<link rel="import" href="user-login-up-form.html">
<dom-module id="user-login-up">
	<style>
		:host {
			@apply(--layout-horizontal);
		}
		.capitalize {
			text-transform: initial !important;
			font-size: 0.7em;
			padding-left: 5px;
		}
		paper-button {
		}
	</style>
	<template>
		<template is="dom-if" if="{{!isSomebody}}" restamp>
			<user-login-up-form username="{{user}}" password="{{pw}}"></user-login-up-form>
		</template>
		<paper-button on-tap="_loginout">
			<iron-icon icon="{{icon}}"></iron-icon>
			<label class="capitalize">{{msg}}</label>
		</paper-button>
	</template>
	<script>
		Polymer({
			is: 'user-login-up',
			properties: {
				isSomebody: {
					type: Boolean,
					notify: true
				},

				msg: {
					type: String,
					notify: true
				},

				icon: {
					type: String,
					notify: true
				},

				user: {
					type: String,
					notify: true
				},
				pw: {
					type: String,
					notify: true
				}
			},

			attached: function()
			{
				if( typeof(Storage) !== "undefined" ) {
					// Code for sessionStorage.
					// TODO: Add functionality to support storing auth for longer period
					if ( sessionStorage.upauth == null || sessionStorage.upauth == "" ) {
						/*continue to be nobody*/
						this.isSomebody = false;
						this.icon = "exit-to-app";
						this.msg = "Log-in";
					} else {
						this.isSomebody = true;
						this.icon = "social:person";
						this.msg = "Log-out";
					}
				} else {
					app.$.toast.text = 'Sorry! No Web Storage support... ';
					app.$.toast.show();
				}
			},

			//	Commputed (Functions)
			//============================
			_computedIcon: function(isSomebody)
			{
				if (isSomebody) {
					this.icon = "social:person";
					this.msg = "Log-out";
				} else {
					this.icon = "exit-to-app";
					this.msg = "Log-in";
				}
			},


			//	EventHandler (Functions)
			//============================
			_loginout: function(e) {
				e.stopPropagation();
				if (this.isSomebody) {
					//log-out
					sessionStorage.removeItem("upauth");
					this.icon = "social:person";
					this.msg = "Log-out";
					this.isSomebody = false;
					Polymer.dom.flush();
					this.updateStyles();
					window.location.reload();
				} else {
					//log-in
					if (this.user == undefined || this.user == "" || this.pw == "" || this.pw == undefined) {
						app.$.toast.text = 'Please enter your username and password to login. ';
						app.$.toast.show();
						return;
					}
					up = this.user + ":" + this.pw;
					var bs64Encode = window.btoa(up);

					//TODO: make an ajax request to find-out if the user is known/authorize
					/*if ( request == "OK" ) {
					 //store and reload
					 sessionStorage.setItem("upauth", bs64Encode);
					 window.location.reload();
					 } else {
					 // something is wrong. Either display the error message or just go with this
					 app.$.toast.text = 'Authentication failed. Invalid username and password. ';
					 app.$.toast.show();
					 return;
					 }*/

					sessionStorage.setItem("upauth", bs64Encode);

					//then,
					window.location.reload();

				}
				e.stopPropagation();
			}
		});
	</script>
</dom-module>